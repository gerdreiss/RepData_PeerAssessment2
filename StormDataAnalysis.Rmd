# Storms in the United States 1950 - 2011
========================================================================================================

TODO: Synopsis describing the analysis

## Data Processing

The data has been processed and analysed using the following environment settings:

```{r session_info}
sessionInfo()
```

Following libraries that are going to be used for the analysis and need installing and attaching:

```{r install_packages, results='hide', message=F, warning=F}
## install dplyr if not already done so
if (("dplyr" %in% (installed.packages())) == F) {
        install.packages("dplyr")
}
## install quantmod if not already done so
if (("quantmod" %in% (installed.packages())) == F) {
        install.packages("quantmod")
}

library(dplyr)
library(quantmod)
```

Download and read the data for the analysis:

```{r read_data, cache=TRUE, results='hide', message=F, warning=F}
## the name of the dataset file
data_file <- "StormData.csv"

## download dataset file if not already done so
if (!file.exists(data_file)) {
        ## download the dataset
        download.file(url = "https://d396qusza40orc.cloudfront.net/repdata/data/StormData.csv.bz2", 
                      destfile = "StormData.csv.bz2", method = "curl")
        system("bunzip2 StormData.csv.bz2")
}

## read the entire dataset into a data frame
rawdata <- read.csv(file = data_file)
```

Now we will take a look at the data and make some transformations.
First, view the structure of the data frame:

```{r data_str}
str(rawdata)
```

For our analysis we're interested in the following columns as described in the [Code Book](http://ire.org/media/uploads/files/datalibrary/samplefiles/Storm%20Events/layout08.doc):

- EVTYPE - The event type
- FATALITIES - The number of direct fatalities
- INJURIES - The number of direct injuries
- PROPDMG - The damage to the properties
- PROPDMGEXP - The exponent used to calculate the total amount of property damage
- CROPDMG - The damage to the crops
- CROPDMGEXP - The exponent used to calculate the total amount of crop damage

Select only data we're interested in, and transform values in formats that make the analysis easier:

```{r select_convert_data}
## create function that will convert character vectors to numeric exponents
convert_exp <- function(exponent) {
        sapply(exponent, function(exponent) {
                ## try converting to numeric
                n_exp = as.numeric(exponent)
                ## if the result is NA...
                if (is.na(n_exp)) {
                        ## ...convert Factor to character vector, and
                        s_exp = toupper(as.character(exponent))
                        ## ...convert according to this table:
                        ## Hundred (H), Thousand (K), Million (M), Billion (B)
                        n_exp = ifelse(s_exp == "H", 2,
                                ifelse(s_exp == "K", 3,
                                ifelse(s_exp == "M", 6,
                                ifelse(s_exp == "B", 9, 0))))
                }
                return(n_exp)
        })
}
## using the function convert_exp convert the columns PROPDMGEXP and CROPDMGEXP into numeric exponents
data <- tbl_df(rawdata) %>%
        ## select the data we're interested in
        select(BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP) %>%
        mutate(YEAR = as.numeric(format(as.Date(as.character(BGN_DATE), format="%m/%d/%Y %H:%M:%S"), "%Y")),
               EVTYPE = as.character(EVTYPE), 
               ## convert exponents using function convert_exp
               PROPDMGEXP = convert_exp(PROPDMGEXP), 
               CROPDMGEXP = convert_exp(CROPDMGEXP),
               ## calculate damage using the converted numeric exponents
               PROPDMGCASH = PROPDMG * 10^PROPDMGEXP,
               CROPDMGCASH = CROPDMG * 10^CROPDMGEXP,
               ## calculate total economic damage
               TOTALDMGCASH = PROPDMGCASH + CROPDMGCASH,
               ## drop BGN_DATE column
               BGN_DATE = NULL)

## print out the first 10 lines to see the result of the transformation above:
head(data, 10)
```

Check the values for some of the columns by printing out the unique values:

```{r unique_values}
unique(data$EVTYPE)
unique(data$PROPDMGEXP)
unique(data$CROPDMGEXP)
```

The values for PROPDMGEXP and CROPDMGEXP seem reasonable, but there are some values in the column EVTYPE that 
don't make any sense:

```{r useless_evtype}
data$EVTYPE[grepl("Summary", data$EVTYPE)]
```

The values are all summaries of some other dates. Checking the values of the raw data:

```{r check_rawdata}
summaries <- rawdata[grepl("Summary", rawdata$EVTYPE), ]

## Check whether this data contains any useful data:
sum(summaries$FATALITIES)
sum(summaries$INJURIES)
sum(summaries$PROPDMG)
sum(summaries$CROPDMG)
```

All these columns contain zero (0) values, so we can discard them:

```{r discard_useless}
data <- filter(data, grepl("Summary", EVTYPE) == FALSE)
```

Considering that the data starts from years 1950 - 2011 we should adjust the damage sums for inflation:

```{r adjusting_inflation}
invisible(getSymbols("CPIAUCSL", src='FRED'))
avg_cpi <- apply.yearly(CPIAUCSL, mean)
conversion_factors <- as.data.frame(avg_cpi / as.numeric(avg_cpi['2011']))
conversion_factors$year = as.numeric(format(as.Date(rownames(conversion_factors)), '%Y'))
colnames(conversion_factors)[1] = 'FACTOR'

data = merge(data, conversion_factors, by='year')
data$TOTALDMGCASH = data$TOTALDMGCASH * data$FACTOR
```


Beside the summary rows, we've seen values that are slightly different, but have very similar meaning in terms of the type of the event, e.g. "coastal flood"" and "coastal flooding". We will try to merge them into a smaller set of event types to make the analysis exacter:

```{r merge_evtypes, cache=TRUE}
## create function that will merge similar event type names
merge_evtypes <- function(evtype) {
        UPR = toupper(gsub("^\\s+|\\s+$", "", evtype))
        new_evtype = ifelse(grepl("HURRICANE|TYPHOON", UPR), "HURRICANE",
                ifelse(grepl("(THUNDER|THUNER|THUDER|THUNDEER|TUNDER|TSTM).?", UPR) & !grepl("NON", UPR), "THUNDERSTORM", 
                ifelse(grepl("(RECORD|HEAVY|EXCESSIVE|UNSEASONAL).?RAIN.*", UPR) & !grepl("THUNDERSTORM|TSTM|NON", UPR), "HEAVY RAIN",
                ifelse(grepl("STORM SURGE", UPR), "STORM SURGE", 
                ifelse(grepl("(GRASS|WILD|FOREST).?FIRE", UPR), "WILD FIRE",
                ifelse(grepl("HEAT", UPR), "HEAT", 
                ifelse(grepl("COLD|FREEZE|FROST", UPR) & !grepl("AIR|FOG|WET|SNOW", UPR), "", 
                ifelse(grepl("(HIGH|BLOWING|STRONG).?WIND", UPR), "",
                ifelse(grepl("FLOOD", UPR), "FLOOD",
                ifelse(grepl("TROPICAL.?STORM", UPR), "TROPICAL STORM", 
                ifelse(grepl("FOG", UPR), "FOG",
                ifelse(grepl("WINTRY|WINTER", UPR), "WINTER WEATHER",
                ifelse(grepl("HAIL.?", UPR), "HAIL",
                ifelse(grepl("BLOWING.?SNOW", UPR), "BLOWING SNOW",
                ifelse(grepl("DRY.?MICROBURST", UPR), "DRY MICROBURST",
                ifelse(grepl("FREEZING.?(DRIZZLE|RAIN|SPRAY)", UPR), "FREEZING RAIN",
                ifelse(grepl("(RECORD|HEAVY).?SNOW", UPR), "HEAVY SNOW",
                ifelse(grepl("ICE|ICY", UPR), "ICE",
                ifelse(grepl("LIGHTNING", UPR), "LIGHTNING",
                ifelse(grepl("RIP.?CURRENT.?", UPR), "RIP CURRENT",
                ifelse(grepl("TORNADO|TORNDAO", UPR), "TORNADO",
                ifelse(grepl("GUSTY.*WIND.*", UPR), "GUSTY WIND",
                ifelse(grepl("COLD.*WET.*", UPR), "COLD AND WET",
                ifelse(grepl("EXTREME.*WIND.*(DAMAGE|STORM)*", UPR), "EXTREME WIND",
                ifelse(grepl("HIGH.*SURF.*", UPR), "HIGH SURF",
                ifelse(grepl("LAKE.*EFFECT.*SNOW", UPR), "LAKE EFFECT SNOW",
                ifelse(grepl("LAND.*(SLIDE|SLIDES|SLUMP|SPOUT)", UPR), "LAND SLIDE",
                ifelse(grepl("LIGHTING|LIGHTNING|LIGNTNING", UPR), "LIGHTNING",
                ifelse(grepl("MICROBURST", UPR), "MICROBURST",
                ifelse(grepl("MUD.*SLIDE.*", UPR), "MUD SLIDE",
                ifelse(grepl("WATERSPOUT.*", UPR), "WATERSPOUT", UPR)))))))))))))))))))))))))))))))

        return(new_evtype)
}
## merge similar event types
data$EVTYPE <- sapply(data$EVTYPE, merge_evtypes)
```


## Results

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?  

Calculate total fatalities and injuries per event type:

```{r population_damage}
pop_harm <- data %>%
        group_by(EVTYPE) %>%
        summarize(total_fatalities = sum(FATALITIES), total_injuries = sum(INJURIES)) %>%
        filter(EVTYPE != "" & (total_fatalities > 0 | total_injuries > 0))
```


2. Across the United States, which types of events have the greatest economic consequences?  
 
```{r economic_damage}
eco_harm <- data %>%
        group_by(EVTYPE) %>%
        summarize(total_damage = sum(TOTALDMGCASH)) %>%
        filter(EVTYPE != "" & total_damage > 0)
```








